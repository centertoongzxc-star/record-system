<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบบันทึกข้อมูลกำลังพล</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .form-box { background: white; padding: 15px; border-radius: 10px; width: 350px; margin-bottom: 20px; }
    table { width: 100%; background: white; border-collapse: collapse; }
    table, th, td { border: 1px solid #999; }
    th, td { padding: 8px; text-align: center; }
    .status-red { color: red; font-weight: bold; }
    .status-green { color: green; font-weight: bold; }
    .status-orange { color: orange; font-weight: bold; }
    button { margin-top: 10px; padding: 8px 15px; border: none; cursor: pointer; border-radius: 5px; }
    .delete-btn { background: #ff4d4d; color: white; }
    .export-btn { background: #007bff; color: white; }
</style>
</head>
<body>

<h2>ระบบบันทึกข้อมูลกำลังพล</h2>

<div class="form-box">
    <label>หมวด:</label>
    <select id="category">
        <option value="นายสิบ">นายสิบ</option>
        <option value="พลทหาร">พลทหาร</option>
        <option value="รายวัน">รายวัน</option>
    </select><br><br>

    <label>ชื่อ – สกุล:</label>
    <input type="text" id="name"><br><br>

    <label>จำนวนเงิน:</label>
    <input type="number" id="amount" placeholder="บาท"><br><br>

    <label>วิธีการจ่าย:</label>
    <select id="payType">
        <option value="เงินสด">เงินสด</option>
        <option value="เงินโอน">เงินโอน</option>
    </select><br><br>

    <label>สถานะการจ่าย:</label>
    <select id="status">
        <option value="ยังไม่จ่าย">ยังไม่จ่าย</option>
        <option value="จ่ายแล้ว">จ่ายแล้ว</option>
        <option value="เซ็น">เซ็น</option>
    </select><br><br>

    <button onclick="addData()">บันทึกข้อมูล</button>
    <button onclick="clearAll()">ลบข้อมูลทั้งหมด</button>
</div>

<h3>ตารางข้อมูล</h3>
<table id="dataTable">
    <thead>
        <tr>
            <th>หมวด</th>
            <th>ชื่อ</th>
            <th>จำนวนเงิน</th>
            <th>วิธีจ่าย</th>
            <th>สถานะ</th>
            <th>เวลา</th>
            <th>ลบ</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<br>
<button class="export-btn" onclick="exportExcel()">ส่งออกเป็น Excel</button>

<script>
// ================= Firebase Config ===================
const firebaseConfig = {
  apiKey: "AIzaSyBveeJ85HW7T0mx_sQk24z0NcJoLRAsiC8",
  authDomain: "create-project-b45b8.firebaseapp.com",
  databaseURL: "https://create-project-b45b8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "create-project-b45b8",
  storageBucket: "create-project-b45b8.appspot.com",
  messagingSenderId: "525737791508",
  appId: "1:525737791508:web:a590cd52f1295597801701"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= Data ===================
let dataList = [];

// โหลดข้อมูลจาก Firebase
function loadData() {
    db.ref('records').on('value', (snapshot) => {
        dataList = [];
        snapshot.forEach((child) => {
            dataList.push({ id: child.key, ...child.val() });
        });
        loadTable();
    });
}

// แสดงตาราง
function loadTable() {
    const table = document.querySelector("#dataTable tbody");
    table.innerHTML = "";

    const order = { "นายสิบ": 1, "พลทหาร": 2, "รายวัน": 3 };
    const sortedList = dataList.sort((a,b) => order[a.category]-order[b.category]);

    sortedList.forEach((item) => {
        let statusClass = item.status === "ยังไม่จ่าย" ? "status-red"
                         : item.status === "จ่ายแล้ว" ? "status-green"
                         : "status-orange";

        table.innerHTML += `
            <tr>
                <td>${item.category}</td>
                <td>${item.name}</td>
                <td>${item.amount} บาท</td>
                <td>${item.payType}</td>

                <td>
                    <select onchange="updateStatus('${item.id}', this.value)" class="${statusClass}">
                        <option value="ยังไม่จ่าย" ${item.status=="ยังไม่จ่าย"?"selected":""}>ยังไม่จ่าย</option>
                        <option value="จ่ายแล้ว" ${item.status=="จ่ายแล้ว"?"selected":""}>จ่ายแล้ว</option>
                        <option value="เซ็น" ${item.status=="เซ็น"?"selected":""}>เซ็น</option>
                    </select>
                </td>

                <td>${item.time}</td>
                <td><button class="delete-btn" onclick="deleteData('${item.id}')">ลบ</button></td>
            </tr>
        `;
    });
}

// เพิ่มข้อมูล
function addData() {
    const category = document.getElementById("category").value;
    const name = document.getElementById("name").value.trim();
    const amount = document.getElementById("amount").value;
    const payType = document.getElementById("payType").value;
    const status = document.getElementById("status").value;

    if(name === "" || amount === "") { alert("กรุณากรอกชื่อ และจำนวนเงิน"); return; }

    const now = new Date().toLocaleString("th-TH");
    const newData = { category, name, amount, payType, status, time: now };

    db.ref('records').push(newData);

    document.getElementById("name").value = "";
    document.getElementById("amount").value = "";
}

// เปลี่ยนสถานะในตาราง
function updateStatus(id, newStatus) {
    db.ref('records/' + id).update({ status: newStatus });
}

// ลบข้อมูล
function deleteData(id) {
    db.ref('records/' + id).remove();
}

// ลบข้อมูลทั้งหมด
function clearAll() {
    if(confirm("คุณต้องการลบข้อมูลทั้งหมดหรือไม่?")) {
        db.ref('records').remove();
    }
}

// ส่งออก Excel
function exportExcel() {
    const order = { "นายสิบ": 1, "พลทหาร": 2, "รายวัน": 3 };
    const sortedList = [...dataList].sort((a,b)=>order[a.category]-order[b.category]);

    let sheet = XLSX.utils.json_to_sheet(sortedList.map(({category,name,amount,payType,status,time})=>({category,name,amount,payType,status,time})));
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,sheet,"Data");
    XLSX.writeFile(wb,"รายงานกำลังพล.xlsx");
}

loadData();
</script>

</body>
</html>
